# 🚀 CI/CD 문서

해당 문서는 본 프로젝트의 CI/CD 실행 흐름과 설계 원칙을 작성해놓은 것입니다. 프리릴리즈와 정식 릴리즈를 구분하여 정리하였으며 실패 시 대응 전략 등을 포함합니다.

<br />

## 📌 기본 사전 설정

### 1) 릴리즈 정책과 브랜치 전략

- `프리릴리즈`: 기능 브랜치 → dev 브랜치

- `정식 릴리즈`: dev 브랜치 → main 브랜치

### 2) `Changesets`을 이용해 버전 및 릴리즈 노트 관리

- 자동 버전 관리 및 changelog 생성

- 수동 버전 업데이트 실수 방지

### 3) GitHub 브랜치 보호 및 머지 조건 설정

- 대상 브랜치: dev, main

- 설정:

  - 브랜치 삭제 금지

  - 강제 푸시 금지

  - 머지 전에 PR 올려야 함

  - PR 머지 전 CI 통과 필수

    - 머지 전에 PR 브랜치가 최신 상태여야 함

    - PR 브랜치에 머지 대상 브랜치 변경사항 반영 → CI 재실행 트리거 → CI 통과 시 머지 가능

<br />

## ✨ 전체적인 플로우

### 1) [기능 개발 후 프리릴리즈 과정](./release-next.md)

### 2) [테스트 완료 후 정식 릴리즈 과정](./release-prod.md)

<br />

## 💡 그 외 주의사항

### 🔖 릴리즈 실패 대응 전략

- 프리릴리즈 시 `npm 배포 X` + `changeset 버전 업데이트 X`

  - 둘 다 진행되지 않았다면, changeset 관련 코드를 수정하지 않아도 됨

- 프리릴리즈 시 `npm 배포 X` + `changeset 버전 업데이트 O`

  - 이전에 버전 업데이트 시 반영된 변경사항들 원복

    - `package.json` 파일에서 버전 원복

    - `CHANGELOG.md` 파일에서 이전 버전 업데이트 로그 삭제

    - `.changeset/pre.json` 파일의 changeset 배열에서 관련 md 파일명 제거

  - changeset 재실행

    - changeset은 정식 실리즈와 달리 프리릴리즈의 경우 버전 업데이트를 해도 `.changeset/*.md`을 없애지 않음

    - 현재 md 파일을 그대로 둔 채 github actions에서 버전 업데이트하면, 이전에 해당 파일을 기반으로 이미 버전 업데이트 시 생겼던 변경사항들이 이미 기준 브랜치에 반영되어 있기 때문에, 릴리즈 PR을 생성하기 위해 새로운 브랜치의 변경사항을 커밋하려고 할 때 변경사항이 없어서 에러가 남

    - 새로운 브랜치에서 기존 `.changeset/*.md` 삭제

    - `pnpm changeset` 실행하여 새로운 md 파일 추가

- 프리릴리즈 시 `npm 배포 O` + `changeset 버전 업데이트 X`

  - CI/CD 흐름상 이런 경우는 발생하기 어려움

  - 만약 수동으로 잘못 실행했다면, 이미 npm에 배포된 것은 되돌릴 수 없으므로 수동으로 changeset 관련 파일들을 배포된 버전에 맞춰 수정한 후 이후의 작업들을 진행해야 함

  - `changesets/action@v1` 대신 changeset cli를 정의해둔 스크립트 실행

- 하나라도 실패하면 전체 워크플로우 중단, 알람 설정 (TODO)

### 🔖 릴리즈 PR에서는 기능 작업 금지

- 기능 PR이 머지되면서 버전 업데이트 커밋을 내용으로 하는 릴리즈 PR이 생성됨

- `changeset` 워크플로우 상, 해당 커밋은 `CHANGELOG.md`에 기능 PR의 본문 내용을 자동으로 포함시킴

- 그렇기에 릴리즈 PR에서 추가 커밋을 하면 `CHANGELOG.md`에 반영되지 않고 누락될 수 있음

- 따라서 릴리즈 PR에서는,

  - 기능/수정/스타일 등의 작업을 가능한 한 하지 않도록 함

  - CI 통과 후 머지만 수행하여 릴리즈 프로세스를 트리거하는 용도로만 사용

### 🔖 pnpm 캐싱 적용

- pnpm은 `node_modules`를 하드링크 기반으로 구성하기 때문에, 일반적인 `node_modules` 디렉토리를 캐싱하는 방식은 오히려 비효율적일 수 있음

- `~/.pnpm-store` 디렉토리를 캐싱하여 복원 속도 향상 및 중복 다운로드 방지
