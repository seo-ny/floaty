# CI/CD 문서

## 📌 기본 사전 설정

### 1) 릴리즈 정책과 브랜치 전략

- `프리릴리즈`: 기능 브랜치 → dev 브랜치

- `정식 릴리즈`: dev 브랜치 → main 브랜치

### 2) `Changesets`을 이용해 버전 및 릴리즈 노트 관리

- 자동 버전 관리 및 changelog 생성

- 수동 버전 업데이트 실수 방지

### 3) GitHub 브랜치 보호 및 머지 조건 설정

- 대상 브랜치: dev, main

- 설정:

  - 브랜치 삭제 금지

  - 강제 푸시 금지

  - rebase merge만 가능하도록 설정

  - 머지 전에 PR 올려야 함

  - PR 머지 전 CI 통과 필수

    - 머지 전에 PR 브랜치가 최신 상태여야 함

    - PR 브랜치에 머지 대상 브랜치 변경사항 반영 → CI 재실행 트리거 → CI 통과 시 머지 가능


<br />


## ✨ 전체적인 플로우

### 1) [기능 개발 후 프리릴리즈 과정](./release-next.md)

### 2) [테스트 완료 후 정식 릴리즈 과정](./release-prod.md)

<br />

## 💡 그 외 주의사항

### 1) pnpm 캐싱 적용

- pnpm은 `node_modules`를 하드링크 기반으로 구성하기 때문에, 일반적인 `node_modules` 디렉토리를 캐싱하는 방식은 오히려 비효율적일 수 있음

- `~/.pnpm-store` 디렉토리를 캐싱하여 복원 속도 향상 및 중복 다운로드 방지

### 2) 릴리즈 실패 대응 전략

- `태그 푸시 X + 릴리즈 X`

  - 워크플로우 재실행 or 수동 릴리즈로 복구 가능

- `태그 푸시 O + 릴리즈 X`

  - `npm publish` 실패했지만 태그는 푸시된 상태일 때, scoped 패키지는 `npm unpublish` 사용 불가능

  - 차선책으로 버전을 한 단계 더 올려서 다시 publish

  - 이전 버전은 태그는 존재하지만, 릴리즈는 건너뛴 상태로 남음

- 실패 지점을 명확히 식별할 수 있도록 각 릴리즈 과정을 step으로 나눔 (묶어서 실행 X)

- 하나라도 실패하면 전체 워크플로우 중단, 알람 설정 (TODO)

### 3) 릴리즈 PR에서는 기능 작업 금지

- 기능 PR이 머지되면서 버전 업데이트 커밋을 내용으로 하는 릴리즈 PR이 생성됨

- `changesets` 워크플로우 상, 해당 커밋은 `CHANGELOG.md`에 기능 PR의 본문 내용을 자동으로 포함시킴

- 그렇기에 릴리즈 PR에서 추가 커밋을 하면 `CHANGELOG.md`에 반영되지 않고 누락될 수 있음

- 따라서 릴리즈 PR에서는,

  - 기능/수정/스타일 등의 작업을 절대 하지 않도록 함

  - CI 통과 후 머지만 수행하여 릴리즈 프로세스를 트리거하는 용도로만 사용