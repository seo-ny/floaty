# CI/CD 문서

## 1. 기본 사전 설정

### 1) 브랜치 전략과 릴리즈 정책

- 기능 브랜치 → dev 브랜치: 프리릴리즈

- dev 브랜치 → main 브랜치: 정식 릴리즈

### 2) Changesets 기반 버전 및 릴리즈 노트 관리

- 자동 버전 관리 및 changelog 생성을 위한 필수 도구

- 수동 버전 업데이트 실수를 방지

- changeset version 실행 시 커밋 발생 → 릴리즈 PR 구성

### 3) GitHub 브랜치 보호 및 병합 조건 설정

- 대상 브랜치: dev, main

- 설정:

  - 브랜치 삭제 금지

  - 강제 푸시 금지

  - PR 병합 전 CI 통과 필수
    - 이 룰을 적용하기 위해 실제로 github actions를 한번은 실행시켜서 워크플로우 파일 안의 job을 읽어와야 체크할 상태들 선택 가능 (TODO)

  - 병합 대상 브랜치 변경 시 최신 상태 반영 후 재검증 필요

- PR 브랜치에 병합 대상 브랜치 변경사항 반영 → CI 재실행 트리거 → CI 통과 시 머지 가능


<br />


## 2. 전체적인 플로우 ✨

### 1) [기능 개발 후 프리릴리즈 과정](./release-next.md)

### 2) [테스트 완료 후 정식 릴리즈 과정](./release-prod.md)

<br />

## 3. 그 외 주의사항

### 1) pnpm 캐싱 적용

- pnpm은 node_modules를 하드링크 기반으로 구성하기 때문에, 일반적인 node_modules 디렉토리를 캐싱하는 방식은 오히려 비효율적일 수 있음

- ~/.pnpm-store 디렉토리 (pnpm store path)를 캐싱하여 복원 속도 향상 및 중복 다운로드 방지 가능

### 2) 릴리즈 실패 대응 전략

- 하나라도 실패하면 전체 워크플로우 중단, 알람 설정 (TODO)

- 실패 지점을 명확히 식별할 수 있도록 각 릴리즈 과정을 step으로 나누기 (묶어서 실행 X)

- 릴리즈 실패 + 태그 푸시 X

  - 워크플로우 재실행 or 수동 릴리즈로 복구 가능

- 릴리즈 실패 + 태그 푸시 O

  - 가장 처리하기 곤란한 경우임

  - npm publish 실패했지만 태그는 푸시된 상태일 때, scoped 패키지는 npm unpublish 불가능

  - 차선책으로 버전을 한 단계 더 올려서 다시 publish

  - 이전 버전은 태그만 존재하지만, 릴리즈는 건너뛰는 상태로 남음

### 3) 릴리즈 PR에서는 기능 작업 금지

- changesets 워크플로우 상, 릴리즈 PR은 CHANGELOG.md를 자동 생성하는 역할을 함

- 릴리즈 PR에서 추가 커밋을 하면 changelog에 반영되지 않고 누락될 수 있음

- 따라서 릴리즈 PR에서는:

  - 기능/수정/스타일 등의 작업을 절대 하지 않음

  - CI 통과 후 머지만 수행하여 릴리즈 프로세스를 트리거하는 용도로만 사용